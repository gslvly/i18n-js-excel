<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>翻译excel-js互转</title>
  <script src="shim.min.js"></script>
  <script src="xlsx.full.min.js"></script>
  <script src="index.js"></script>
</head>

<body>
  <style>
    code {
      background: #eee;
    }
  </style>
  <div>
    <h5>js → excel</h5>
    js转换excel,请从开发环境中复制需要翻译的locales数据，并粘贴到下面输入框中，locales格式为：{zh-CN:{title:'xxx'}, en:{title:'xx'},....其他语言}。
    <pre>注：可直接使用 <code>console.log(JSON.stringify(locales))</code> ,在调试框里面复制数据</pre>
    <pre>
      
      <button onclick="toExcel()" >生成excel</button>
    </pre>
    <textarea id="json" cols="30" rows="10"></textarea>
  </div>
  <hr>
  <div>
    <h5>excel→js:ipgard加密文件需先解码</h5>

    <div>
      <div>
        excel转换为js，excel的第一行对应的是js的文件名，一般为语言代码
      </div>
      转换优先顺序为：使用模板转换 > 使用key转换。如果需要使用key转换，请不要选择模板js
      <br>使用模板转换，会用正则替换模板的数据，能够准确的复制模板的写法，但一词多译时，只会选择最后那个模板对应翻译。
      <br>使用key转换，能够准确的生成翻译对应关系，但生成的js文件只有一个写法：export default {xxx}。excel必须有"key"为表头的列
    </div>


    <div style="margin-top: 20px">
      模板js: <input type="file" class="tojs-js">
    </div>

    <div>
      excel文件：<input type="file" class="tojs-excel">
      <div>excel文件的sheetName: <input type="text" value="Sheet1" class="sheet-name"></div>
    </div>
    <button class="tojs" onclick="toJs()">转换成js</button>
    <hr>
    项目地址: git@192.168.19.225:web/i18n-xlsx-js.git
    <br>
    自主解码工具地址: git@192.168.19.225:web/ipguard-decrypt.git
  </div>
  <script>
    document.querySelector('input').checked = true
    function toExcel() {
      let locales = document.querySelector('#json').value
      if (!locales) return alert('没有数据')
      locales = new Function(`return ${locales}`)()
      if (!isObj(locales)) {
        return alert('格式不对')
      }

      let arr = jsonsToArray(locales, true) // locales为{"zh-CN":{xxx}, en:{xxx}...}，参数二： 不使用key。使用key可以查询未翻译的字段
      // arr = noRepeat(arr,'zh-CN') // 参数2：按中文去重,不传为按照所有语言翻译都相等来去重。可不使用。
      downloadExcel(arr)
    }

    async function toJs() {
      const temp = document.querySelector('.tojs-js').files[0]

      const sheetName = document.querySelector('.sheet-name').value
      const excelInput = document.querySelector('.tojs-excel')
      const excelFile = excelInput.files[0]
      if (!excelFile) {
        return alert('先选excel文件')
      }
      let excelData
      try {
        excelData = await getXLSLdata(excelFile, sheetName)
      } catch (e) {
        return alert(e)
      }

      let needDatas
      if (temp) {
        const tempStr = await reader.readAsText(temp)
        const tempLang = temp.name.replace(/\.js$/, '')
        needDatas = getLangObjByTemp(tempStr, excelData, tempLang)
      } else {

        if (Object.keys(excelData[0]).indexOf('key') === -1) {
          return alert('excel表格没有为"key"为表头的列,请选择模板')
        }

        needDatas = getLangObjByKey(excelData)
      }

      Object.keys(needDatas).forEach(lang => {
        download(needDatas[lang], `${lang}.js`)
      })
    }
  </script>
</body>

</html>