<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>翻译excel-js互转</title>
    <script src="shim.min.js"></script>
    <script src="xlsx.full.min.js"></script>
    <script src="md5.js"></script>
    <script src="index.js?v1.2"></script>
  </head>

  <body>
    <style>
      code {
        background: #eee;
      }
      .tips {
        font-size: 12px;
        color: #333;
      }
    </style>
    <div>
      <h5>js → excel</h5>
      js转换excel,请从开发环境中复制需要翻译的locales数据，并粘贴到下面输入框中，locales格式为：{zh-CN:{title:'xxx'},
      en:{title:'xx'},....其他语言}。
      <pre>
注：可直接使用 <code>console.log(JSON.stringify(locales))</code> ,在调试框里面复制数据</pre
      >
      <pre>
      
      <button onclick="toExcel()" >生成excel</button>
    </pre>
      <textarea id="json" cols="30" rows="10"></textarea>
    </div>
    <hr />
    <div>
      <h5>js文件翻译</h5>

      <div>
        <ol>
          <li>如果输入了js模板，则会使用js模板生成对应的翻译js文件。</li>
          <li>
            如果没有js模板内容，则会使用excel的“key”列来作为json的key（如：excel
            key为:'a.b.c'，语言列zh-CN为‘天气’，会 生成{a:b:{c:'天气'}}）。
          </li>
        </ol>
        <div class="tips">
          注：
          <br />使用模板转换，会用正则替换模板的数据，能够准确的复制模板的写法，但一词多译时，只会选择最后那个模板对应翻译。
          <br />使用key转换，能够准确的生成翻译对应关系，但生成的js文件只有一个写法：export
          default
          {xxx}，且只能生成一个文件。excel必须有"key"为表头的列。推荐使用模板js文件生成翻译文件，
        </div>
      </div>

      <div style="margin-top: 20px">
        模板js语言：<input type="radio" class="org-langs" value="zh-CN" />中文
        <input type="radio" class="org-langs" value="en" />英语
        <input type="radio" class="org-langs" value="es" />西班牙语言
        <input type="radio" class="org-langs" value="ja" />日语
        <input type="radio" class="org-langs" value="ru-RU" />俄语
        <br />
        模板内容：（js文件的内容）
        <br />
        <textarea class="tojs-js" cols="30" rows="10"></textarea
        >
      </div>

      <div>
        目标语言：
        <input type="checkbox" class="langs" value="zh-CN" />中文
        <input type="checkbox" class="langs" value="en" />英语
        <input type="checkbox" class="langs" value="es" />西班牙语言
        <input type="checkbox" class="langs" value="ja" />日语
        <input type="checkbox" class="langs" value="ru-RU" />俄语
      </div>
      <div>
        excel文件作为翻译源：<input type="file" class="tojs-excel" />

        <div class="tips">
          excel文件第一行必须为标准语言代码('zh-CN','en','es',('key')...),其中key为'a.b.c'
          非必需
        </div>
        <div>
          excel文件的sheetName:
          <input type="text" value="Sheet1" class="sheet-name" />
        </div>
      </div>
      <div style="margin: 8px 0">
        <input
          type="checkbox"
          class="baidu"
          value="true"
        />使用百度辅助翻译（excel中缺少的翻译，百度来翻译）
      </div>
      <button class="tojs" onclick="toJs()">转换成js</button>
      <hr />
      项目地址: git@192.168.19.225:web/i18n-xlsx-js.git
      <br />
      自主解码工具地址: git@192.168.19.225:web/ipguard-decrypt.git
    </div>
    <script>
      document.querySelector('input').checked = true
      function toExcel() {
        let locales = document.querySelector('#json').value
        if (!locales) return alert('没有数据')
        try {
          locales = new Function(`return ${locales}`)()
        } catch (err) {
          return alert('格式不对')
        }
        if (!isObj(locales)) {
          return alert('格式不对')
        }

        let arr = jsonsToArray(locales, true) // locales为{"zh-CN":{xxx}, en:{xxx}...}，参数二： 不使用key。使用key可以查询未翻译的字段
        // arr = noRepeat(arr,'zh-CN') // 参数2：按中文去重,不传为按照所有语言翻译都相等来去重。可不使用。
        downloadExcel(arr)
      }

      async function toJs() {
        const tempStr = document.querySelector('.tojs-js').value
        const tempLang = document.querySelector('.org-langs:checked').value
        const isUseBaidu = document.querySelector('.baidu').checked

        const sheetName = document.querySelector('.sheet-name').value
        const excelInput = document.querySelector('.tojs-excel')
        const excelFile = excelInput.files[0]
        const toLangs = [...document.querySelectorAll('.langs:checked')].map(
          it => it.value
        )
        if (!toLangs.length) {
          return alert('请选择目标语言')
        }

        // 检查数据
        if (!tempStr && !excelFile) {
          return alert('请先选择需要翻译的内容')
        }

        if (!excelFile && !isUseBaidu) {
          return alert('先选excel文件或者勾选百度翻译')
        }

        let excelData
        if (excelFile) {
          try {
            excelData = await getXLSLdata(excelFile, sheetName)
          } catch (e) {
            return alert(e)
          }
        }

        let needDatas
        if (
          !tempStr &&
          excelData &&
          !Object.keys(excelData[0]).includes('key')
        ) {
          return alert(
            'excel表格没有为"key"为表头的列,请粘贴模板内容，选择模板语言'
          )
        }
        // 检查数据结束
        try {
          if (tempStr) {
            needDatas = await getLangObjByTemp({
              tempStr,
              excelData,
              tempLang,
              isUseBaidu,
              toLangs
            })
          } else {
            needDatas = await getLangObjByKey({
              excelData,
              isUseBaidu,
              toLangs
            })
          }
        } catch (err) {
          console.error(err)
          alert(err)
        }

        Object.keys(needDatas).forEach(lang => {
          download(needDatas[lang], `${lang}.js`)
        })
      }
    </script>
  </body>
</html>
